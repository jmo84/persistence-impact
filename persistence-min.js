ig.module("plugins.persistence").requires("impact.game").defines(function(){Persistence=ig.Class.extend({init:function(){this.stateLoadFunctions=Persistence.globalLoadFunctions.slice(0);this.stateSaveFunctions=Persistence.globalSaveFunctions.slice(0)},getLevelState:function(){var e,i,t,s,n=false,r=ig.game.entities.slice(0);if(this.killedEntities)r=r.concat(this.killedEntities);for(e=0;e<r.length;e++){i=r[e];if(!i.persist)continue;s=this.getEntityIdentifier(i);if(!s)continue;t={id:s,x:i.pos.x,y:i.pos.y};if(i._killed||i.isKilled)t.killed=1;this.runStateHandlers("Save",i,t);if(i.persistenceSave)i.persistenceSave(t);if(!n)n=[];n.push(t)}return n},loadLevelState:function(e){var i=ig.game.entities,t=0,s,n;this.killedEntities=[];for(s=0;s<i.length;s++){n=i[s];if(!n.persist)continue;n.originPersistId={x:n.pos.x,y:n.pos.y};if(e)if(this.loadEntityState(n,e))t++;else;}return t},loadEntityState:function(e,i){var t=this.getEntityIdentifier(e),s,n,r,l;for(n=0;n<i.length;n++){s=i[n];if(s.id==t){this.runStateHandlers("Load",e,s);if(e.persistenceLoad)e.persistenceLoad(s);for(r in s)if(s.hasOwnProperty(r)){l=s[r];if("id"==r)e.idPersisted=l;else if("x"==r)e.pos.x=l;else if("y"==r)e.pos.y=l;else if("killed"==r)ig.game.removeEntity(e);else e[r]=l}return true}}return false},getEntityIdentifier:function(e){var i=e.originPersistId||e.pos;return"x_"+i.x+"_y_"+i.y},runStateHandlers:function(e,i,t){var s,n,r=this["state"+e+"Functions"];if(!r)return;for(n=0;n<r.length;n++){s=r[n];s.call(i,t)}}});Persistence.globalLoadFunctions=[];Persistence.globalSaveFunctions=[];ig.Game.inject({staticInstantiate:function(){this.parent();ig.game.persistence=new Persistence},removeEntity:function(e){if(e.persist&&!e._killed){if(!this.persistence.killedEntities)this.persistence.killedEntities=[];this.persistence.killedEntities.push(e)}this.parent(e)}})});